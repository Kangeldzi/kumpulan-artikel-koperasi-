<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Tabungan Digital - Koperasi Asmara Tani</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* ===== RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #1a5f23;
            --primary-light: #2e7d32;
            --primary-dark: #0d4014;
            --secondary: #ff9800;
            --accent-blue: #2196f3;
            --accent-purple: #9c27b0;
            --danger: #f44336;
            --warning: #ffc107;
            --success: #4caf50;
            --info: #2196f3;
            
            --bg-light: #f5f6fa;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #888888;
            --border-color: #eeeeee;
            
            --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 15px 35px rgba(0, 0, 0, 0.1);
            --shadow-dark: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            background: linear-gradient(135deg, #f8fff8 0%, #f0f7f0 50%, #e8f5e9 100%);
            color: var(--text-primary);
            padding-bottom: 30px;
            min-height: 100vh;
            position: relative;
        }

        /* Background pattern subtle */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(26, 95, 35, 0.03) 0%, transparent 55%),
                radial-gradient(circle at 75% 75%, rgba(255, 152, 0, 0.02) 0%, transparent 55%);
            z-index: -1;
        }

        /* ===== HEADER PROFILE ===== */
        .profile-container {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 0 0 30px 30px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 15px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .profile-container::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(30deg);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .avatar {
            width: 72px;
            height: 72px;
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info h2 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
        }

        .badge {
            background: white;
            color: var(--primary);
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .username {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 2px;
        }

        /* ===== BUTTON AREA ===== */
        .btn-area {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }

        .btn {
            flex: 1;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn.qr {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-primary);
            backdrop-filter: blur(10px);
        }

        .btn.qr:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .btn.pro {
            background: linear-gradient(135deg, var(--secondary), #ff8a00);
            color: white;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .btn.pro:hover {
            background: linear-gradient(135deg, #ffb347, #ffcc80);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3);
        }

        /* ===== CARD PLAN ===== */
        .plan-card {
            background: linear-gradient(135deg, #2A9D8F 0%, #1D6F7D 100%);
            color: white;
            margin: 20px;
            padding: 25px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
            border: none;
        }

        .plan-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(30deg);
        }

        .plan-left {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .plan-icon {
            width: 50px;
            height: 35px;
            background: linear-gradient(135deg, #fff, #aaa);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .plan-text h3 {
            font-size: 22px;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .plan-text p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ===== MENU LIST ===== */
        .menu-section {
            background: var(--card-bg);
            margin: 15px;
            border-radius: 20px;
            padding: 5px 0;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 15px;
            border-bottom: 1px solid var(--border-color);
            text-decoration: none;
            color: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: linear-gradient(90deg, rgba(26, 95, 35, 0.03), rgba(26, 95, 35, 0.08));
            padding-left: 20px;
        }

        .menu-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 10px rgba(26, 95, 35, 0.2);
        }

        .menu-text {
            font-size: 15px;
            font-weight: 500;
        }

        .menu-right {
            color: var(--text-muted);
            font-size: 14px;
        }

        .badge-red {
            background: var(--danger);
            color: white;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            padding: 20px 15px;
            margin-top: 30px;
            color: var(--text-secondary);
            font-size: 14px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary-light), transparent);
        }

        .footer p {
            margin: 0;
            padding: 10px 0;
            color: var(--primary);
            font-weight: 500;
        }

        /* ===== BACK HOME BUTTON ===== */
        .back-home {
            display: block;
            margin: 30px auto 20px;
            padding: 14px 25px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(26, 95, 35, 0.2);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .back-home::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .back-home:hover::before {
            opacity: 1;
        }

        .back-home:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(26, 95, 35, 0.3);
        }

        .back-home i {
            margin-right: 8px;
            transition: transform 0.3s ease;
        }

        .back-home:hover i {
            transform: translateX(-3px);
        }

        /* ===== STATS CARD STYLES ===== */
        .stats-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            margin: 20px 15px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ===== MODAL STYLES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .modal-header h3 {
            font-size: 18px;
            color: white;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 20px;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            transition: all 0.3s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 35, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26, 95, 35, 0.2);
        }

        .modal-btn.secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-btn.secondary:hover {
            background: #e4e6eb;
        }

        /* ===== TOAST STYLES ===== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--accent-blue);
        }

        /* ===== KARTU DIGITAL STYLES ===== */
        .kartu-container {
            text-align: center;
            padding: 10px 0;
        }

        .kartu-digital {
            background: linear-gradient(135deg, #ffffff, #f5f5f5);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .kartu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .kartu-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-weight: bold;
            font-size: 18px;
        }

        .kartu-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .kartu-photo {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid var(--primary);
            flex-shrink: 0;
        }

        .kartu-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .kartu-details {
            flex: 1;
        }

        .kartu-details h4 {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .kartu-nia {
            font-size: 14px;
            color: var(--primary);
            font-weight: 500;
            margin-bottom: 3px;
        }

        .kartu-posisi, .kartu-join {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .kartu-qr {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #qrcode-container {
            width: 150px;
            height: 150px;
            margin-bottom: 10px;
            border: 10px solid white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background: white;
            padding: 10px;
        }

        .qr-code-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        /* ===== NOTIFIKASI STYLES ===== */
        .notifikasi-container {
            padding: 10px 0;
        }

        .notifikasi-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notifikasi-item {
            padding: 15px;
            background: var(--bg-light);
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--info);
        }

        .notifikasi-item.unread {
            background: #e3f2fd;
            border-left: 4px solid var(--accent-blue);
        }

        .notifikasi-title {
            font-weight: 500;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .notifikasi-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .notifikasi-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ===== PASSWORD INPUT STYLES ===== */
        .password-input-container {
            position: relative;
            width: 100%;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .password-toggle:hover {
            color: var(--primary);
            background: rgba(26, 95, 35, 0.1);
        }

        /* ===== SHARE MODAL STYLES ===== */
        .share-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .share-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-option:hover {
            background: #e4e6eb;
            transform: translateX(5px);
        }

        .share-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .share-icon.whatsapp {
            background: #25D366;
        }

        .share-icon.email {
            background: #EA4335;
        }

        .share-icon.other {
            background: var(--accent-blue);
        }

        .share-text {
            flex: 1;
            text-align: left;
        }

        .share-text strong {
            display: block;
            margin-bottom: 2px;
        }

        .share-text span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-card, .print-card * {
                visibility: visible;
            }
            
            .print-card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }
            
            .no-print {
                display: none !important;
            }
        }

        /* Print Card */
        .print-card {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 3000;
            padding: 20px;
            overflow-y: auto;
        }
        
        @media print {
            .print-card {
                display: block;
            }
            .no-print {
                display: none;
            }
        }

        /* ===== PRINT BUTTON STYLES ===== */
        .print-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
            background: linear-gradient(135deg, #495057, #343a40);
        }

        /* ===== SMALL BUTTONS STYLES ===== */
        .small-buttons {
            gap: 8px;
            margin-top: 20px;
        }
        
        .small-btn {
            padding: 10px 12px !important;
            font-size: 13px !important;
            border-radius: 10px !important;
        }

        /* ===== QR SCAN DISPLAY STYLES ===== */
        .qr-scan-display {
            background: white;
            border: 15px solid var(--primary);
            border-radius: 30px;
            padding: 30px;
            margin: 20px auto;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .qr-scan-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(26, 95, 35, 0.05), rgba(255, 152, 0, 0.05));
            z-index: 0;
        }

        .qr-scan-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .qr-scan-header h2 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .qr-scan-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .qr-scan-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .qr-scan-frame {
            border: 5px solid var(--primary-light);
            border-radius: 20px;
            padding: 20px;
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .qr-scan-details {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            border-left: 5px solid var(--success);
        }

        .qr-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #dee2e6;
        }

        .qr-detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .qr-detail-label {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .qr-detail-value {
            color: var(--text-primary);
            text-align: right;
        }

        .qr-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .qr-status-active {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .qr-status-inactive {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: white;
        }

        /* ===== REAL-TIME SYNC STYLES ===== */
        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            z-index: 1000;
            transition: all 0.3s ease;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .sync-indicator.syncing {
            background: #2196F3;
            animation: spin 1s linear infinite;
        }
        
        .sync-indicator.success {
            background: #4CAF50;
        }
        
        .sync-indicator.error {
            background: #F44336;
        }
        
        .last-sync-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 3px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-sync-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .avatar {
                width: 60px;
                height: 60px;
            }
            
            .user-info h2 {
                font-size: 18px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .footer {
                font-size: 13px;
                padding: 15px;
            }
            
            .back-home {
                padding: 12px 20px;
                font-size: 14px;
            }
        }

        @media (min-width: 768px) {
            body {
                max-width: 400px;
                margin: 0 auto;
                box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <!-- ===== STRUKTUR DATA TERPUSAT ===== -->
    <script>
    // ===== STRUKTUR DATA TERPUSAT =====
    function initializeKoperasiData() {
        console.log('Initializing Koperasi Data Structure...');
        
        // Cek jika koperasiData belum ada
        if (!localStorage.getItem('koperasiData')) {
            const initialData = {
                version: '2.0',
                createdAt: new Date().toISOString(),
                lastSync: new Date().toISOString(),
                anggotaData: [],
                adminUpdates: {},
                userUpdates: {},
                syncLog: [],
                settings: {
                    minSimpanan: 10000,
                    minPinjaman: 100000,
                    bungaPinjaman: 1.2,
                    bungaSimpanan: 0.5,
                    adminWhatsapp: '085218483129',
                    namaKoperasi: 'Koperasi Asmara Tani',
                    tahunBuku: 2026
                }
            };
            localStorage.setItem('koperasiData', JSON.stringify(initialData));
            console.log('Created new koperasiData structure');
        }
        
        // Pastikan anggotaData ada
        if (!localStorage.getItem('anggotaData')) {
            localStorage.setItem('anggotaData', JSON.stringify([]));
            console.log('Created new anggotaData array');
        }
        
        // Pastikan adminUpdates ada
        if (!localStorage.getItem('adminUpdates')) {
            localStorage.setItem('adminUpdates', JSON.stringify({}));
            console.log('Created new adminUpdates object');
        }
        
        console.log('Koperasi data structure initialized successfully');
        return true;
    }
    
    // Jalankan saat halaman load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeKoperasiData);
    } else {
        initializeKoperasiData();
    }
    </script>

    <!-- ===== PROFILE HEADER ===== -->
    <div class="profile-container">
        <div class="profile-header">
            <div class="avatar">
                <img id="profileAvatar" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg" alt="Profile">
            </div>
            <div class="user-info">
                <h2 id="profileName">Loading... <span class="badge">‚úî</span></h2>
                <div class="username" id="profileRole">@loading</div>
                <div class="last-sync-time" id="lastSyncTime">Terakhir sinkron: -</div>
            </div>
        </div>

        <div class="btn-area">
            <button class="btn qr" id="qrButton">
                <i class="fas fa-qrcode"></i> Tampilkan QR
            </button>
            <button class="btn pro" id="upgradeButton">
                <i class="fas fa-edit"></i> Edit Profil
            </button>
        </div>
    </div>

    <!-- ===== CARD PLAN ===== -->
    <div class="plan-card">
        <div class="plan-left">
            <div class="plan-icon">
                <i class="fas fa-book-open" style="color: #333;"></i>
            </div>
            <div class="plan-text">
                <h3 id="tabunganTitle">Tabungan Digital</h3>
                <p id="tabunganStatus">Memuat status...</p>
            </div>
        </div>
    </div>

    <!-- ===== STATS CARD ===== -->
    <div class="stats-card">
        <div class="stats-header">
            <div class="stats-title">Ringkasan Keuangan</div>
            <div id="syncIndicator" class="sync-indicator success" title="Terhubung real-time"></div>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="totalSimpanan">Rp 0</div>
                <div class="stat-label">Total Simpanan</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalPinjaman">Rp 0</div>
                <div class="stat-label">Pinjaman</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="shuEstimasi">Rp 0</div>
                <div class="stat-label">SHU Estimasi</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statusAnggota">...</div>
                <div class="stat-label">Status Anggota</div>
            </div>
        </div>
    </div>

    <!-- ===== MENU 1: AKSI CEPAT ===== -->
    <div class="menu-section">
        <div class="menu-item" data-action="setor">
            <div class="menu-left">
                <div class="menu-icon">üì•</div>
                <div class="menu-text">Setor Simpanan</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item" data-action="pinjam">
            <div class="menu-left">
                <div class="menu-icon">ü´¥üèº</div>
                <div class="menu-text">Ajukan Pinjaman</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item" data-action="riwayat">
            <div class="menu-left">
                <div class="menu-icon">üìù</div>
                <div class="menu-text">Riwayat Transaksi</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item" data-action="kartu">
            <div class="menu-left">
                <div class="menu-icon">ü™™</div>
                <div class="menu-text">Kartu Anggota</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>
    </div>

    <!-- ===== MENU 2: TAMPILAN KARTU ===== -->
    <div class="menu-section">
        <div class="menu-item" data-action="total_simpanan">
            <div class="menu-left">
                <div class="menu-icon">ü™ô</div>
                <div class="menu-text">Total Simpanan</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item" data-action="pinjaman_aktif">
            <div class="menu-left">
                <div class="menu-icon">üíµ</div>
                <div class="menu-text">Pinjaman Aktif</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item" data-action="shu_estimasi">
            <div class="menu-left">
                <div class="menu-icon">üíé</div>
                <div class="menu-text">SHU Estimasi</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>
    </div>

    <!-- ===== BACK HOME BUTTON ===== -->
    <button class="back-home" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-left"></i> Kembali ke Beranda 
    </button>

    <!-- ===== FOOTER ===== -->
    <div class="footer">
        <p>Copyright ¬© Koperasi Asmara Tani 2026</p>
    </div>

    <!-- ===== MODAL OVERLAY ===== -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal Title</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- ===== TOAST CONTAINER ===== -->
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toastMessage">Toast message here</span>
    </div>

    <!-- ===== PRINT CARD (HIDDEN) ===== -->
    <div id="printCard" class="print-card"></div>

    <!-- ===== SINKRONISASI REAL-TIME MANAGER ===== -->
    <script>
    console.log('Loading Sync Manager...');

    class DataSyncManager {
        constructor() {
            this.syncInterval = 3000; // Sinkron setiap 3 detik
            this.isSyncing = false;
            this.syncTimeout = null;
            this.init();
        }
        
        init() {
            console.log('Sync Manager Initialized');
            
            // Mulai sinkronisasi
            this.startSync();
            
            // Event listener untuk update dari tab/browser lain
            window.addEventListener('storage', (e) => {
                if (e.key === 'koperasiData' || e.key === 'adminUpdates' || e.key === 'anggotaData') {
                    console.log('Storage changed:', e.key);
                    this.onDataChanged(e.key);
                }
            });
            
            // Event listener untuk sebelum tab/window ditutup
            window.addEventListener('beforeunload', () => {
                if (this.syncTimeout) {
                    clearTimeout(this.syncTimeout);
                }
            });
        }
        
        startSync() {
            // Sync pertama kali dengan delay 1 detik
            setTimeout(() => this.syncData(), 1000);
            
            // Sync periodik
            this.syncTimeout = setInterval(() => {
                if (!this.isSyncing) {
                    this.syncData();
                }
            }, this.syncInterval);
        }
        
        syncData() {
            if (this.isSyncing) {
                console.log('Sync already in progress, skipping...');
                return;
            }
            
            this.isSyncing = true;
            console.log('Starting data sync...');
            
            try {
                const koperasiData = JSON.parse(localStorage.getItem('koperasiData')) || {};
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                
                // Update sync timestamp
                koperasiData.lastSync = new Date().toISOString();
                koperasiData.syncCount = (koperasiData.syncCount || 0) + 1;
                
                // Log sinkronisasi
                this.logSync('SYNC_START', 'Memulai sinkronisasi data');
                
                // Role-based sync
                if (currentUser) {
                    if (currentUser.role === 'admin') {
                        this.pushAdminUpdates(koperasiData);
                    } else {
                        this.pullAdminUpdates(koperasiData, currentUser.email);
                    }
                }
                
                // Simpan data terupdate
                localStorage.setItem('koperasiData', JSON.stringify(koperasiData));
                
                this.logSync('SYNC_SUCCESS', 'Sinkronisasi berhasil');
                console.log('Data sync completed successfully');
                
                // Show sync indicator
                this.showSyncIndicator('success');
                
                // Update last sync time in UI
                this.updateLastSyncTime();
                
            } catch (error) {
                console.error('Sync Error:', error);
                this.logSync('SYNC_ERROR', error.message);
                this.showSyncIndicator('error');
            } finally {
                this.isSyncing = false;
            }
        }
        
        pushAdminUpdates(koperasiData) {
            const adminUpdates = JSON.parse(localStorage.getItem('adminUpdates')) || {};
            
            if (Object.keys(adminUpdates).length > 0) {
                console.log('Pushing admin updates:', Object.keys(adminUpdates).length, 'updates');
                
                // Gabungkan dengan existing updates
                koperasiData.adminUpdates = { 
                    ...koperasiData.adminUpdates, 
                    ...adminUpdates 
                };
                
                // Update timestamp
                koperasiData.lastAdminPush = new Date().toISOString();
                
                // Log
                this.logSync('ADMIN_PUSH', `Push ${Object.keys(adminUpdates).length} updates`);
                
                // Kosongkan adminUpdates lokal setelah dipush
                localStorage.setItem('adminUpdates', JSON.stringify({}));
            }
        }
        
        pullAdminUpdates(koperasiData, userEmail) {
            if (koperasiData.adminUpdates && koperasiData.adminUpdates[userEmail]) {
                console.log('Pulling updates for:', userEmail);
                
                const updates = koperasiData.adminUpdates[userEmail];
                const semuaAnggota = JSON.parse(localStorage.getItem('anggotaData')) || [];
                const userIndex = semuaAnggota.findIndex(a => a.email === userEmail);
                
                if (userIndex !== -1) {
                    let updated = false;
                    
                    // Apply simpanan updates
                    if (updates.simpanan) {
                        Object.keys(updates.simpanan).forEach(jenis => {
                            if (semuaAnggota[userIndex].simpanan) {
                                semuaAnggota[userIndex].simpanan[jenis] = {
                                    ...semuaAnggota[userIndex].simpanan[jenis],
                                    ...updates.simpanan[jenis],
                                    updatedAt: new Date().toISOString()
                                };
                                updated = true;
                            }
                        });
                        
                        // Recalculate total
                        if (semuaAnggota[userIndex].simpanan) {
                            semuaAnggota[userIndex].simpanan.total = 
                                (semuaAnggota[userIndex].simpanan.pokok?.nominal || 0) +
                                (semuaAnggota[userIndex].simpanan.wajib?.nominal || 0) +
                                (semuaAnggota[userIndex].simpanan.sukarela?.nominal || 0);
                        }
                    }
                    
                    // Apply personal data updates
                    if (updates.personal) {
                        semuaAnggota[userIndex] = {
                            ...semuaAnggota[userIndex],
                            ...updates.personal,
                            updatedAt: new Date().toISOString()
                        };
                        updated = true;
                    }
                    
                    // Apply pinjaman updates
                    if (updates.pinjaman) {
                        semuaAnggota[userIndex].pinjaman = {
                            ...semuaAnggota[userIndex].pinjaman,
                            ...updates.pinjaman
                        };
                        updated = true;
                    }
                    
                    // Apply SHU updates
                    if (updates.shu) {
                        semuaAnggota[userIndex].shu = {
                            ...semuaAnggota[userIndex].shu,
                            ...updates.shu
                        };
                        updated = true;
                    }
                    
                    // Update metadata
                    semuaAnggota[userIndex].lastUpdated = new Date().toISOString();
                    semuaAnggota[userIndex].updatedBy = 'admin';
                    
                    if (updated) {
                        // Simpan data yang diupdate
                        localStorage.setItem('anggotaData', JSON.stringify(semuaAnggota));
                        
                        // Trigger UI update
                        this.triggerUIUpdate(userEmail, updates);
                        
                        // Log
                        this.logSync('USER_UPDATE', `Data diperbarui untuk ${userEmail}`);
                        
                        // Show notification
                        this.showNotification('Data diperbarui oleh admin!', 'info');
                    }
                    
                    // Hapus update yang sudah diproses
                    delete koperasiData.adminUpdates[userEmail];
                    
                    // Log removal
                    this.logSync('UPDATE_CLEARED', `Update cleared for ${userEmail}`);
                }
            }
        }
        
        triggerUIUpdate(userEmail, updates) {
            // Dispatch custom event untuk update UI
            const event = new CustomEvent('dataSynced', {
                detail: { 
                    email: userEmail,
                    updates: updates,
                    timestamp: new Date().toISOString(),
                    source: 'admin'
                }
            });
            window.dispatchEvent(event);
            
            // Juga dispatch event khusus untuk tabungan digital
            if (window.tabungan) {
                const tabunganEvent = new CustomEvent('tabunganDataUpdated', {
                    detail: { email: userEmail }
                });
                window.dispatchEvent(tabunganEvent);
            }
        }
        
        showNotification(message, type = 'info') {
            // Hanya tampilkan jika di tabungan digital
            if (window.tabungan && window.tabungan.showToast) {
                window.tabungan.showToast(message, type);
            } else if (window.showNotification) {
                window.showNotification(message, type);
            } else {
                // Fallback notification
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
        
        showSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                indicator.classList.remove('syncing', 'success', 'error');
                
                if (status === 'syncing') {
                    indicator.classList.add('syncing');
                    indicator.title = 'Menyinkronkan data...';
                } else if (status === 'success') {
                    indicator.classList.add('success');
                    indicator.title = 'Data tersinkron ' + new Date().toLocaleTimeString();
                    
                    // Remove success class after 2 seconds
                    setTimeout(() => {
                        indicator.classList.remove('success');
                    }, 2000);
                } else if (status === 'error') {
                    indicator.classList.add('error');
                    indicator.title = 'Gagal sinkronisasi';
                    
                    // Remove error class after 5 seconds
                    setTimeout(() => {
                        indicator.classList.remove('error');
                    }, 5000);
                }
            }
        }
        
        updateLastSyncTime() {
            const lastSyncElement = document.getElementById('lastSyncTime');
            if (lastSyncElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                lastSyncElement.textContent = `Terakhir sinkron: ${timeString}`;
            }
        }
        
        logSync(type, message) {
            const log = {
                type,
                message,
                timestamp: new Date().toISOString(),
                user: JSON.parse(localStorage.getItem('currentUser'))?.email || 'system',
                userAgent: navigator.userAgent
            };
            
            const koperasiData = JSON.parse(localStorage.getItem('koperasiData')) || {};
            koperasiData.syncLog = koperasiData.syncLog || [];
            koperasiData.syncLog.push(log);
            
            // Keep only last 50 logs
            if (koperasiData.syncLog.length > 50) {
                koperasiData.syncLog = koperasiData.syncLog.slice(-50);
            }
            
            localStorage.setItem('koperasiData', JSON.stringify(koperasiData));
        }
        
        onDataChanged(key) {
            console.log(`Data changed: ${key}`);
            
            // Refresh UI berdasarkan perubahan
            if (key === 'anggotaData') {
                if (window.loadAnggotaData) {
                    window.loadAnggotaData();
                }
                if (window.refreshAnggotaTable) {
                    window.refreshAnggotaTable();
                }
            }
            
            if (window.tabungan && window.tabungan.updateProfileUI) {
                window.tabungan.updateProfileUI();
            }
            
            // Dispatch change event
            const event = new CustomEvent('localStorageChanged', {
                detail: { key: key }
            });
            window.dispatchEvent(event);
        }
        
        // Manual sync
        manualSync() {
            console.log('Manual sync triggered');
            this.showSyncIndicator('syncing');
            this.syncData();
        }
        
        // Get sync status
        getSyncStatus() {
            const koperasiData = JSON.parse(localStorage.getItem('koperasiData')) || {};
            return {
                lastSync: koperasiData.lastSync,
                syncCount: koperasiData.syncCount || 0,
                pendingUpdates: Object.keys(koperasiData.adminUpdates || {}).length,
                logCount: (koperasiData.syncLog || []).length
            };
        }
    }

    // Global instance
    window.SyncManager = DataSyncManager;
    console.log('Sync Manager loaded successfully');
    </script>

    <!-- ===== DIGITAL TABUNGAN SCRIPT ===== -->
    <script>
    // ===== DASHBOARD FUNCTIONALITY =====
    class DigitalTabungan {
        constructor() {
            // Cek jika user sudah login
            this.currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!this.currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            this.loadAnggotaData();
            this.init();
            
            // Setup real-time sync
            this.setupRealTimeSync();
            this.startSyncInterval();
        }

        loadAnggotaData() {
            const semuaAnggota = JSON.parse(localStorage.getItem('anggotaData')) || [];
            const anggota = semuaAnggota.find(a => a.email === this.currentUser.email);
            
            if (anggota) {
                this.anggotaData = {
                    personal: {
                        nama: anggota.nama || '',
                        nia: anggota.id || '',
                        telepon: anggota.whatsapp || '',
                        email: anggota.email || '',
                        posisi: anggota.posisi || 'Anggota',
                        tanggalGabung: anggota.tanggalDaftar || '',
                        status: anggota.statusAktif || 'Aktif',
                        password: anggota.password || '',
                        foto: anggota.foto || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg',
                        alamat: anggota.alamat || '',
                        jenisKelamin: anggota.jenisKelamin || '',
                        agama: anggota.agama || '',
                        statusPerkawinan: anggota.status || '',
                        nik: anggota.nik || '',
                        tanggalDaftar: anggota.tanggalDaftar || '',
                        lastUpdated: anggota.lastUpdated || ''
                    },
                    simpanan: anggota.simpanan || {
                        pokok: { nominal: 200000, status: 'lunas' },
                        wajib: { nominal: 20000, status: 'aktif', terakhirBayar: 'Jan 2025' },
                        sukarela: { nominal: 7900000, status: 'tersedia' },
                        total: 8250000
                    },
                    pinjaman: anggota.pinjaman || {
                        aktif: [],
                        total: 0
                    },
                    shu: anggota.shu || {
                        estimasi: 3200000,
                        status: 'Dalam perhitungan'
                    },
                    notifikasi: anggota.notifikasi || []
                };
            } else {
                this.anggotaData = {
                    personal: {
                        nama: this.currentUser.name || '',
                        nia: '',
                        telepon: '',
                        email: this.currentUser.email || '',
                        posisi: this.currentUser.role || 'Anggota',
                        tanggalGabung: '',
                        status: 'Belum Aktif',
                        password: '',
                        foto: this.currentUser.foto || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg',
                        alamat: '',
                        jenisKelamin: '',
                        agama: '',
                        statusPerkawinan: '',
                        nik: '',
                        tanggalDaftar: ''
                    },
                    simpanan: {
                        pokok: { nominal: 0, status: 'belum lunas' },
                        wajib: { nominal: 0, status: 'belum aktif', terakhirBayar: '' },
                        sukarela: { nominal: 0, status: 'tersedia' },
                        total: 0
                    },
                    pinjaman: {
                        aktif: [],
                        total: 0
                    },
                    shu: {
                        estimasi: 0,
                        status: 'Belum ada perhitungan'
                    },
                    notifikasi: []
                };
            }
            
            // Update current user data
            this.currentUser.name = this.anggotaData.personal.nama || this.currentUser.email;
            this.currentUser.foto = this.anggotaData.personal.foto;
            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
        }

        saveAnggotaData() {
            const semuaAnggota = JSON.parse(localStorage.getItem('anggotaData')) || [];
            const index = semuaAnggota.findIndex(a => a.email === this.currentUser.email);
            
            const anggotaDataToSave = {
                id: this.anggotaData.personal.nia || '',
                nama: this.anggotaData.personal.nama,
                whatsapp: this.anggotaData.personal.telepon,
                email: this.anggotaData.personal.email,
                posisi: this.anggotaData.personal.posisi,
                alamat: this.anggotaData.personal.alamat || '',
                jenisKelamin: this.anggotaData.personal.jenisKelamin || '',
                agama: this.anggotaData.personal.agama || '',
                status: this.anggotaData.personal.statusPerkawinan || '',
                nik: this.anggotaData.personal.nik || '',
                tanggalDaftar: this.anggotaData.personal.tanggalDaftar || this.anggotaData.personal.tanggalGabung || '',
                statusAktif: this.anggotaData.personal.status,
                foto: this.anggotaData.personal.foto,
                password: this.anggotaData.personal.password,
                simpanan: this.anggotaData.simpanan,
                pinjaman: this.anggotaData.pinjaman,
                shu: this.anggotaData.shu,
                notifikasi: this.anggotaData.notifikasi,
                lastUpdated: new Date().toISOString(),
                lastUpdatedBy: 'user', // Tandai bahwa update berasal dari user
                version: '2.0'
            };
            
            if (index !== -1) {
                semuaAnggota[index] = anggotaDataToSave;
            } else {
                semuaAnggota.push(anggotaDataToSave);
            }
            
            localStorage.setItem('anggotaData', JSON.stringify(semuaAnggota));
            
            // ===== TAMBAHKAN: Sinkronisasi ke admin (untuk edit profil oleh user) =====
            if (this.currentUser.role !== 'admin') {
                // Simpan perubahan ke userUpdates untuk nanti di-pull oleh admin
                const koperasiData = JSON.parse(localStorage.getItem('koperasiData')) || {};
                koperasiData.userUpdates = koperasiData.userUpdates || {};
                
                // Hanya simpan perubahan profil (personal data)
                const changes = {
                    personal: {
                        nama: this.anggotaData.personal.nama,
                        telepon: this.anggotaData.personal.telepon,
                        alamat: this.anggotaData.personal.alamat,
                        jenisKelamin: this.anggotaData.personal.jenisKelamin,
                        agama: this.anggotaData.personal.agama,
                        statusPerkawinan: this.anggotaData.personal.statusPerkawinan,
                        nik: this.anggotaData.personal.nik,
                        foto: this.anggotaData.personal.foto,
                        posisi: this.anggotaData.personal.posisi,
                        updatedAt: new Date().toISOString(),
                        updatedBy: 'user'
                    }
                };
                
                koperasiData.userUpdates[this.currentUser.email] = changes;
                localStorage.setItem('koperasiData', JSON.stringify(koperasiData));
                
                console.log('User changes saved for admin sync');
            }
        }

        init() {
            this.updateProfileUI();
            this.setupEventListeners();
            
            setTimeout(() => {
                this.showToast(`Selamat datang, ${this.anggotaData.personal.nama || this.currentUser.email}!`, 'success');
            }, 1000);
        }

        setupRealTimeSync() {
            // Event listener untuk sync dari admin
            window.addEventListener('dataSynced', (e) => {
                if (e.detail.email === this.currentUser.email) {
                    console.log('Data synced from admin:', e.detail);
                    this.loadAnggotaData();
                    this.updateProfileUI();
                    this.showToast('Data telah diperbarui oleh admin!', 'success');
                }
            });
            
            // Event khusus untuk tabungan digital
            window.addEventListener('tabunganDataUpdated', (e) => {
                if (e.detail.email === this.currentUser.email) {
                    this.loadAnggotaData();
                    this.updateProfileUI();
                    this.showToast('Data simpanan diperbarui!', 'info');
                }
            });
            
            // Listen untuk storage changes
            window.addEventListener('storage', (e) => {
                if (e.key === 'anggotaData' || e.key === 'adminUpdates' || e.key === 'koperasiData') {
                    this.syncWithAdminData();
                }
            });
            
            // Custom event untuk force refresh
            window.addEventListener('forceRefresh', () => {
                this.loadAnggotaData();
                this.updateProfileUI();
            });
        }

        startSyncInterval() {
            // Auto sync setiap 2 detik untuk real-time update
            setInterval(() => {
                this.syncWithAdminData();
            }, 2000);
        }

        syncWithAdminData() {
            // Cek update dari admin melalui koperasiData
            const koperasiData = JSON.parse(localStorage.getItem('koperasiData')) || {};
            const myUpdates = koperasiData.adminUpdates?.[this.currentUser.email];
            
            if (myUpdates) {
                console.log('Admin updates detected:', myUpdates);
                
                let dataChanged = false;
                
                // Apply simpanan updates
                if (myUpdates.simpanan) {
                    Object.keys(myUpdates.simpanan).forEach(jenis => {
                        if (this.anggotaData.simpanan && this.anggotaData.simpanan[jenis]) {
                            const oldValue = this.anggotaData.simpanan[jenis].nominal;
                            const newValue = myUpdates.simpanan[jenis].nominal;
                            
                            if (oldValue !== newValue) {
                                this.anggotaData.simpanan[jenis] = {
                                    ...this.anggotaData.simpanan[jenis],
                                    ...myUpdates.simpanan[jenis],
                                    updatedAt: new Date().toISOString()
                                };
                                dataChanged = true;
                                console.log(`Simpanan ${jenis} updated: ${oldValue} -> ${newValue}`);
                            }
                        }
                    });
                    
                    // Recalculate total jika ada perubahan
                    if (dataChanged) {
                        this.anggotaData.simpanan.total = 
                            (this.anggotaData.simpanan.pokok?.nominal || 0) +
                            (this.anggotaData.simpanan.wajib?.nominal || 0) +
                            (this.anggotaData.simpanan.sukarela?.nominal || 0);
                    }
                }
                
                // Apply personal data updates
                if (myUpdates.personal) {
                    Object.keys(myUpdates.personal).forEach(key => {
                        if (this.anggotaData.personal[key] !== myUpdates.personal[key]) {
                            this.anggotaData.personal[key] = myUpdates.personal[key];
                            dataChanged = true;
                            console.log(`Personal ${key} updated: ${myUpdates.personal[key]}`);
                        }
                    });
                }
                
                // Apply pinjaman updates
                if (myUpdates.pinjaman) {
                    this.anggotaData.pinjaman = {
                        ...this.anggotaData.pinjaman,
                        ...myUpdates.pinjaman
                    };
                    dataChanged = true;
                }
                
                // Apply SHU updates
                if (myUpdates.shu) {
                    this.anggotaData.shu = {
                        ...this.anggotaData.shu,
                        ...myUpdates.shu
                    };
                    dataChanged = true;
                }
                
                if (dataChanged) {
                    // Simpan perubahan
                    this.saveAnggotaData();
                    
                    // Update UI
                    this.updateProfileUI();
                    
                    // Update current user info jika nama berubah
                    if (myUpdates.personal?.nama) {
                        this.currentUser.name = myUpdates.personal.nama;
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    }
                    
                    // Hapus update yang sudah diproses
                    delete koperasiData.adminUpdates[this.currentUser.email];
                    localStorage.setItem('koperasiData', JSON.stringify(koperasiData));
                    
                    // Tampilkan notifikasi
                    this.showToast('Data berhasil disinkronkan!', 'success');
                }
            }
        }

        updateProfileUI() {
            const profileName = document.getElementById('profileName');
            const profileRole = document.getElementById('profileRole');
            const profileAvatar = document.getElementById('profileAvatar');
            const tabunganTitle = document.getElementById('tabunganTitle');
            const tabunganStatus = document.getElementById('tabunganStatus');
            
            if (this.anggotaData.personal.nama) {
                profileName.innerHTML = `${this.anggotaData.personal.nama} <span class="badge">‚úî</span>`;
                profileRole.textContent = `@${this.anggotaData.personal.posisi.toLowerCase().replace(' ', '_')}`;
                profileAvatar.src = this.anggotaData.personal.foto;
                
                // Tambah indikator sync di foto profil
                if (!document.querySelector('.user-sync-indicator')) {
                    const syncIndicator = document.createElement('div');
                    syncIndicator.className = 'user-sync-indicator';
                    profileAvatar.parentElement.style.position = 'relative';
                    profileAvatar.parentElement.appendChild(syncIndicator);
                }
            } else {
                profileName.innerHTML = `${this.currentUser.email} <span class="badge">?</span>`;
                profileRole.textContent = `@${this.currentUser.role.toLowerCase()}`;
            }
            
            tabunganTitle.textContent = 'Tabungan Digital';
            if (this.anggotaData.personal.status === 'Aktif') {
                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                tabunganStatus.textContent = `Aktif hingga: ${nextYear.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            } else {
                tabunganStatus.textContent = 'Belum aktif - Silakan lengkapi profil';
            }
            
            document.getElementById('totalSimpanan').textContent = `Rp ${this.formatNumber(this.anggotaData.simpanan.total)}`;
            document.getElementById('totalPinjaman').textContent = `Rp ${this.formatNumber(this.anggotaData.pinjaman.total)}`;
            document.getElementById('shuEstimasi').textContent = `Rp ${this.formatNumber(this.anggotaData.shu.estimasi)}`;
            document.getElementById('statusAnggota').textContent = this.anggotaData.personal.status;
            
            // Update last updated time
            if (this.anggotaData.personal.lastUpdated) {
                const lastUpdated = new Date(this.anggotaData.personal.lastUpdated);
                const timeString = lastUpdated.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                const dateString = lastUpdated.toLocaleDateString('id-ID');
                document.getElementById('lastSyncTime').textContent = `Diperbarui: ${dateString} ${timeString}`;
            }
        }

        setupEventListeners() {
            document.getElementById('qrButton').addEventListener('click', () => this.showQRModal());
            document.getElementById('upgradeButton').addEventListener('click', () => this.showEditProfileModal());
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = e.currentTarget.getAttribute('data-action');
                    this.handleMenuAction(action);
                });
            });
            
            document.getElementById('modalClose').addEventListener('click', () => this.closeModal());
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modalOverlay')) {
                    this.closeModal();
                }
            });
        }

        handleMenuAction(action) {
            const actions = {
                setor: () => this.showSetorModal(),
                pinjam: () => this.showPinjamModal(),
                riwayat: () => this.showRiwayatModal(),
                kartu: () => this.showKartuModal(),
                total_simpanan: () => this.showTotalSimpananModal(),
                pinjaman_aktif: () => this.showPinjamanAktifModal(),
                shu_estimasi: () => this.showShuEstimasiModal()
            };

            if (actions[action]) {
                actions[action]();
            }
        }

        // 3. FUNGSIONALITAS TOMBOL SETOR & AJUKAN PINJAMAN
        showSetorModal() {
            this.showModal({
                title: 'Setor Simpanan',
                content: `
                    <div style="padding: 10px 0;">
                        <p>Pilih jenis simpanan yang ingin Anda setor:</p>
                        
                        <div style="margin-top: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 10px;">
                                <strong>Simpanan Pokok</strong>
                                <p style="margin: 5px 0; color: #666; font-size: 13px;">Simpanan pokok sebesar Rp 200.000</p>
                                <p style="color: ${this.anggotaData.simpanan.pokok.status === 'lunas' ? '#2e7d32' : '#f44336'}; font-weight: 500;">
                                    Status: ${this.anggotaData.simpanan.pokok.status === 'lunas' ? '‚úì Sudah Lunas' : '‚úó Belum Lunas'}
                                </p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 10px;">
                                <strong>Simpanan Wajib</strong>
                                <p style="margin: 5px 0; color: #666; font-size: 13px;">Setoran bulanan Rp 20.000</p>
                                <p style="color: ${this.anggotaData.simpanan.wajib.status === 'aktif' ? '#2e7d32' : '#f44336'}; font-weight: 500;">
                                    Status: ${this.anggotaData.simpanan.wajib.status === 'aktif' ? '‚úì Aktif' : '‚úó Tidak Aktif'}
                                </p>
                                <p style="color: #666; font-size: 12px;">Terakhir bayar: ${this.anggotaData.simpanan.wajib.terakhirBayar || '-'}</p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 12px;">
                                <strong>Simpanan Sukarela</strong>
                                <p style="margin: 5px 0; color: #666; font-size: 13px;">Jumlah tersedia: Rp ${this.formatNumber(this.anggotaData.simpanan.sukarela.nominal)}</p>
                                <p style="color: #2e7d32; font-weight: 500;">Status: ‚úì Tersedia</p>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Jumlah Setoran (Rp)</label>
                            <input type="number" class="form-control" id="setorAmount" placeholder="Masukkan jumlah setoran" min="10000" step="1000">
                        </div>
                        
                        <div class="modal-actions">
                            <button class="modal-btn secondary" onclick="window.tabungan.closeModal()">Batal</button>
                            <button class="modal-btn primary" onclick="window.tabungan.hubungiAdminSetor()">
                                <i class="fas fa-paper-plane"></i> Setor Sekarang
                            </button>
                        </div>
                    </div>
                `
            });
        }

        hubungiAdminSetor() {
            const amount = document.getElementById('setorAmount').value;
            if (!amount || amount < 10000) {
                this.showToast('Jumlah setoran minimal Rp 10.000', 'error');
                return;
            }
            
            const message = `Halo Admin Koperasi Asmara Tani,\n\nSaya ${this.anggotaData.personal.nama} (NIA: ${this.anggotaData.personal.nia || 'Belum Terdaftar'}) ingin melakukan setoran simpanan sebesar Rp ${this.formatNumber(amount)}.\n\nMohon bantuan untuk proses setoran. Terima kasih.`;
            const whatsappUrl = `https://wa.me/6285218483129?text=${encodeURIComponent(message)}`;
            
            this.closeModal();
            window.open(whatsappUrl, '_blank');
            this.showToast('Mengarahkan ke WhatsApp Admin...', 'info');
        }

        showPinjamModal() {
            this.showModal({
                title: 'Ajukan Pinjaman',
                content: `
                    <div style="padding: 10px 0;">
                        <p>Silakan lengkapi form pengajuan pinjaman:</p>
                        
                        <div class="form-group">
                            <label class="form-label">Jumlah Pinjaman (Rp)</label>
                            <input type="number" class="form-control" id="pinjamAmount" placeholder="Minimal Rp 100.000" min="100000" step="10000">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Jenis Pinjaman</label>
                            <select class="form-control" id="pinjamJenis">
                                <option value="konsumsi">Konsumsi</option>
                                <option value="produktif">Produktif</option>
                                <option value="emergency">Darurat</option>
                                <option value="pendidikan">Pendidikan</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tenor (Bulan)</label>
                            <select class="form-control" id="pinjamTenor">
                                <option value="6">6 Bulan</option>
                                <option value="12" selected>12 Bulan</option>
                                <option value="18">18 Bulan</option>
                                <option value="24">24 Bulan</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tujuan Pinjaman</label>
                            <textarea class="form-control" id="pinjamTujuan" rows="2" placeholder="Jelaskan tujuan penggunaan pinjaman"></textarea>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin: 20px 0;">
                            <strong>Informasi Penting:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
                                <li>Minimal pinjaman: Rp 100.000</li>
                                <li>Maksimal pinjaman adalah 5x dari total simpanan</li>
                                <li>Bunga pinjaman: 1.2% per bulan</li>
                                <li>Proses persetujuan: 1-3 hari kerja</li>
                            </ul>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="modal-btn secondary" onclick="window.tabungan.closeModal()">Batal</button>
                            <button class="modal-btn primary" onclick="window.tabungan.hubungiAdminPinjaman()">
                                <i class="fas fa-paper-plane"></i> Ajukan Pinjaman
                            </button>
                        </div>
                    </div>
                `
            });
        }

        hubungiAdminPinjaman() {
            const amount = document.getElementById('pinjamAmount').value;
            const jenis = document.getElementById('pinjamJenis').value;
            const tenor = document.getElementById('pinjamTenor').value;
            const tujuan = document.getElementById('pinjamTujuan').value;
            
            if (!amount || amount < 100000) {
                this.showToast('Jumlah pinjaman minimal Rp 100.000', 'error');
                return;
            }
            
            if (!tujuan) {
                this.showToast('Harap isi tujuan pinjaman', 'error');
                return;
            }
            
            const maxPinjaman = this.anggotaData.simpanan.total * 5;
            if (parseInt(amount) > maxPinjaman) {
                this.showToast(`Maksimal pinjaman adalah Rp ${this.formatNumber(maxPinjaman)}`, 'error');
                return;
            }
            
            const message = `Halo Admin Koperasi Asmara Tani,\n\nSaya ${this.anggotaData.personal.nama} (NIA: ${this.anggotaData.personal.nia || 'Belum Terdaftar'}) ingin mengajukan pinjaman dengan detail sebagai berikut:\n\n‚Ä¢ Jumlah Pinjaman: Rp ${this.formatNumber(amount)}\n‚Ä¢ Jenis Pinjaman: ${jenis}\n‚Ä¢ Tenor: ${tenor} bulan\n‚Ä¢ Tujuan: ${tujuan}\n‚Ä¢ Total Simpanan Saat Ini: Rp ${this.formatNumber(this.anggotaData.simpanan.total)}\n\nMohon untuk diproses lebih lanjut. Terima kasih.`;
            const whatsappUrl = `https://wa.me/6285218483129?text=${encodeURIComponent(message)}`;
            
            this.closeModal();
            window.open(whatsappUrl, '_blank');
            this.showToast('Mengarahkan ke WhatsApp Admin...', 'info');
        }

        showRiwayatModal() {
            // Buat riwayat dummy jika tidak ada
            const riwayatDummy = [
                { id: 1, tanggal: '2025-03-15', jenis: 'Setoran Sukarela', jumlah: 500000, status: 'Berhasil' },
                { id: 2, tanggal: '2025-03-10', jenis: 'Setoran Wajib', jumlah: 20000, status: 'Berhasil' },
                { id: 3, tanggal: '2025-02-28', jenis: 'Pinjaman Konsumsi', jumlah: 2000000, status: 'Disetujui' },
                { id: 4, tanggal: '2025-02-15', jenis: 'Setoran Sukarela', jumlah: 1000000, status: 'Berhasil' },
                { id: 5, tanggal: '2025-01-30', jenis: 'Angsuran Pinjaman', jumlah: 350000, status: 'Berhasil' },
            ];
            
            let riwayatHTML = '<div style="padding: 10px 0;">';
            riwayatHTML += '<p>Riwayat transaksi terakhir Anda:</p>';
            
            if (riwayatDummy.length > 0) {
                riwayatHTML += '<div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">';
                riwayatDummy.forEach(transaksi => {
                    riwayatHTML += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #4caf50;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${transaksi.jenis}</strong>
                                    <div style="font-size: 12px; color: #666;">${transaksi.tanggal}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: ${transaksi.jenis.includes('Setoran') ? '#2e7d32' : '#f44336'}">
                                        ${transaksi.jenis.includes('Setoran') ? '+' : '-'}Rp ${this.formatNumber(transaksi.jumlah)}
                                    </div>
                                    <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${transaksi.status === 'Berhasil' ? '#e8f5e9' : '#fff3e0'}; color: ${transaksi.status === 'Berhasil' ? '#2e7d32' : '#f57c00'}">
                                        ${transaksi.status}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                riwayatHTML += '</div>';
            } else {
                riwayatHTML += '<div style="text-align: center; padding: 40px 20px; color: #666;">Belum ada riwayat transaksi</div>';
            }
            
            riwayatHTML += `
                <div class="modal-actions">
                    <button class="modal-btn primary" onclick="window.tabungan.closeModal()" style="width: 100%;">
                        <i class="fas fa-check"></i> Tutup
                    </button>
                </div>
            </div>`;
            
            this.showModal({
                title: 'Riwayat Transaksi',
                content: riwayatHTML
            });
        }

        showPinjamanAktifModal() {
            let pinjamanHTML = '<div style="padding: 10px 0;">';
            pinjamanHTML += '<p>Daftar pinjaman aktif Anda:</p>';
            
            if (this.anggotaData.pinjaman.aktif.length > 0) {
                pinjamanHTML += '<div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">';
                this.anggotaData.pinjaman.aktif.forEach(p => {
                    pinjamanHTML += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #2196f3;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <strong style="text-transform: capitalize;">${p.jenis}</strong>
                                    <div style="font-size: 12px; color: #666;">${p.tanggal}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: #f44336;">Rp ${this.formatNumber(p.jumlah)}</div>
                                    <span style="font-size: 11px; padding: 3px 10px; border-radius: 10px; background: #e3f2fd; color: #1976d2;">
                                        ${p.status}
                                    </span>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">${p.tujuan}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #888;">
                                <span>Tenor: ${p.tenor} bulan</span>
                                <span>Sisa: ${p.sisaTenor} bulan</span>
                                <span>Bunga: ${p.bunga}%</span>
                            </div>
                        </div>
                    `;
                });
                pinjamanHTML += '</div>';
            } else {
                pinjamanHTML += '<div style="text-align: center; padding: 40px 20px; color: #666;">Tidak ada pinjaman aktif</div>';
            }
            
            pinjamanHTML += `
                <div class="modal-actions">
                    <button class="modal-btn primary" onclick="window.tabungan.closeModal()" style="width: 100%;">
                        <i class="fas fa-check"></i> Tutup
                    </button>
                </div>
            </div>`;
            
            this.showModal({
                title: 'Pinjaman Aktif',
                content: pinjamanHTML
            });
        }

        // 1. SHU ESTIMASI DENGAN PRINT OUT
        showShuEstimasiModal() {
            this.showModal({
                title: 'SHU Estimasi',
                content: `
                    <div style="padding: 10px 0;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 36px; font-weight: bold; color: #9c27b0; margin-bottom: 10px;">Rp ${this.formatNumber(this.anggotaData.shu.estimasi)}</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">Estimasi Sisa Hasil Usaha Anda</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Status: ${this.anggotaData.shu.status}</div>
                        </div>
                        
                        <div style="background: #f3e5f6; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <strong style="color: #7b1fa2;">Informasi SHU:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
                                <li>SHU dihitung berdasarkan partisipasi modal dan transaksi</li>
                                <li>Pembagian dilakukan setiap akhir tahun buku</li>
                                <li>Estimasi dapat berubah sesuai kinerja koperasi</li>
                                <li>SHU dapat diambil atau ditambahkan ke simpanan</li>
                            </ul>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Berdasarkan Simpanan:</span>
                                <span style="font-weight: 500; color: #7b1fa2">Rp ${this.formatNumber(this.anggotaData.shu.estimasi * 0.6)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Berdasarkan Transaksi:</span>
                                <span style="font-weight: 500; color: #7b1fa2">Rp ${this.formatNumber(this.anggotaData.shu.estimasi * 0.4)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px; color: #888;">
                                <span>Perkiraan pembagian:</span>
                                <span>Desember 2025</span>
                            </div>
                        </div>
                        
                        <!-- TOMBOL PRINT OUT SHU -->
                        <button class="print-btn" onclick="window.tabungan.printSHU()">
                            <i class="fas fa-print"></i> Print Out SHU
                        </button>
                        
                        <div class="modal-actions">
                            <button class="modal-btn secondary" onclick="window.tabungan.closeModal()">Tutup</button>
                            <button class="modal-btn primary" onclick="window.tabungan.downloadLaporan()">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                    </div>
                `
            });
        }

        // FUNGSI PRINT SHU
        printSHU() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Laporan SHU Estimasi - ${this.anggotaData.personal.nama}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 30px; }
                            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #7b1fa2; padding-bottom: 20px; }
                            .header h1 { color: #7b1fa2; margin-bottom: 5px; }
                            .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            .info-table th, .info-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            .info-table th { background: #f3e5f6; color: #7b1fa2; }
                            .shu-amount { text-align: center; margin: 30px 0; }
                            .shu-amount .value { font-size: 48px; font-weight: bold; color: #7b1fa2; margin: 10px 0; }
                            .shu-amount .label { color: #666; font-size: 18px; }
                            .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 15px; }
                            @media print { body { margin: 15px; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>LAPORAN SHU ESTIMASI</h1>
                            <p>Koperasi Asmara Tani</p>
                            <p>Periode: ${new Date().toLocaleDateString('id-ID')}</p>
                        </div>
                        
                        <table class="info-table">
                            <tr>
                                <th>Nama Anggota</th>
                                <td>${this.anggotaData.personal.nama}</td>
                            </tr>
                            <tr>
                                <th>NIA</th>
                                <td>${this.anggotaData.personal.nia}</td>
                            </tr>
                            <tr>
                                <th>Posisi</th>
                                <td>${this.anggotaData.personal.posisi}</td>
                            </tr>
                            <tr>
                                <th>Status SHU</th>
                                <td>${this.anggotaData.shu.status}</td>
                            </tr>
                        </table>
                        
                        <div class="shu-amount">
                            <div class="label">Estimasi Sisa Hasil Usaha</div>
                            <div class="value">Rp ${this.formatNumber(this.anggotaData.shu.estimasi)}</div>
                        </div>
                        
                        <h3>Rincian Perhitungan</h3>
                        <table class="info-table">
                            <tr>
                                <th>Komponen</th>
                                <th>Persentase</th>
                                <th>Jumlah (Rp)</th>
                            </tr>
                            <tr>
                                <td>Berdasarkan Simpanan</td>
                                <td>60%</td>
                                <td>${this.formatNumber(this.anggotaData.shu.estimasi * 0.6)}</td>
                            </tr>
                            <tr>
                                <td>Berdasarkan Transaksi</td>
                                <td>40%</td>
                                <td>${this.formatNumber(this.anggotaData.shu.estimasi * 0.4)}</td>
                            </tr>
                            <tr style="background: #f8f9fa; font-weight: bold;">
                                <td>TOTAL SHU ESTIMASI</td>
                                <td>100%</td>
                                <td>Rp ${this.formatNumber(this.anggotaData.shu.estimasi)}</td>
                            </tr>
                        </table>
                        
                        <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <strong>Catatan:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>SHU dibagikan setiap akhir tahun buku (Desember)</li>
                                <li>Angka estimasi dapat berubah sesuai kinerja koperasi</li>
                                <li>SHU dapat diambil tunai atau ditambahkan ke simpanan</li>
                            </ul>
                        </div>
                        
                        <div class="footer">
                            <p>Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
                            <p>Koperasi Asmara Tani ¬© 2026</p>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // 2. TAMBAH FITUR GANTI PASSWORD DI EDIT PROFIL
        showEditProfileModal() {
            const { personal } = this.anggotaData;
            
            this.showModal({
                title: 'Edit Profil Anggota',
                content: `
                    <div style="padding: 10px 0;">
                        <form id="editProfileForm">
                            <div class="form-group">
                                <label class="form-label" for="editNama">Nama Lengkap</label>
                                <input type="text" class="form-control" id="editNama" value="${personal.nama || ''}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editNIA">NIA (Nomor Induk Anggota)</label>
                                <input type="text" class="form-control" id="editNIA" value="${personal.nia || ''}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editPosisi">Posisi Sebagai</label>
                                <select class="form-control" id="editPosisi" required>
                                    <option value="Anggota" ${personal.posisi === 'Anggota' ? 'selected' : ''}>Anggota</option>
                                    <option value="Pengurus" ${personal.posisi === 'Pengurus' ? 'selected' : ''}>Pengurus</option>
                                    <option value="Ketua" ${personal.posisi === 'Ketua' ? 'selected' : ''}>Ketua</option>
                                    <option value="Sekretaris" ${personal.posisi === 'Sekretaris' ? 'selected' : ''}>Sekretaris</option>
                                    <option value="Bendahara" ${personal.posisi === 'Bendahara' ? 'selected' : ''}>Bendahara</option>
                                    <option value="Pengawas" ${personal.posisi === 'Pengawas' ? 'selected' : ''}>Pengawas</option>
                                    <option value="Admin" ${personal.posisi === 'Admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editAlamat">Alamat Lengkap</label>
                                <textarea class="form-control" id="editAlamat" rows="2">${personal.alamat || ''}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editJenisKelamin">Jenis Kelamin</label>
                                <select class="form-control" id="editJenisKelamin" required>
                                    <option value="">Pilih Jenis Kelamin</option>
                                    <option value="Laki-laki" ${personal.jenisKelamin === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                                    <option value="Perempuan" ${personal.jenisKelamin === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editAgama">Agama</label>
                                <select class="form-control" id="editAgama" required>
                                    <option value="">Pilih Agama</option>
                                    <option value="Islam" ${personal.agama === 'Islam' ? 'selected' : ''}>Islam</option>
                                    <option value="Kristen" ${personal.agama === 'Kristen' ? 'selected' : ''}>Kristen</option>
                                    <option value="Katolik" ${personal.agama === 'Katolik' ? 'selected' : ''}>Katolik</option>
                                    <option value="Hindu" ${personal.agama === 'Hindu' ? 'selected' : ''}>Hindu</option>
                                    <option value="Buddha" ${personal.agama === 'Buddha' ? 'selected' : ''}>Buddha</option>
                                    <option value="Konghucu" ${personal.agama === 'Konghucu' ? 'selected' : ''}>Konghucu</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editStatus">Status</label>
                                <select class="form-control" id="editStatus" required>
                                    <option value="">Pilih Status</option>
                                    <option value="Menikah" ${personal.statusPerkawinan === 'Menikah' ? 'selected' : ''}>Menikah</option>
                                    <option value="Belum Menikah" ${personal.statusPerkawinan === 'Belum Menikah' ? 'selected' : ''}>Belum Menikah</option>
                                    <option value="Cerai" ${personal.statusPerkawinan === 'Cerai' ? 'selected' : ''}>Cerai</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editTanggalDaftar">Tanggal Daftar</label>
                                <input type="date" class="form-control" id="editTanggalDaftar" value="${personal.tanggalDaftar || ''}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editTanggalGabung">Tanggal Bergabung</label>
                                <input type="date" class="form-control" id="editTanggalGabung" value="${personal.tanggalGabung || ''}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editEmail">Alamat Email</label>
                                <input type="email" class="form-control" id="editEmail" value="${personal.email || ''}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editTelepon">No WhatsApp</label>
                                <input type="tel" class="form-control" id="editTelepon" value="${personal.telepon || ''}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="editNIK">NIK KTP</label>
                                <input type="text" class="form-control" id="editNIK" value="${personal.nik || ''}" required>
                            </div>
                            
                            <!-- FITUR GANTI PASSWORD -->
                            <div class="form-group" style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                                <label class="form-label" style="color: #1a5f23; font-weight: 600;">Ganti Password</label>
                                <div class="password-input-container" style="margin-bottom: 10px;">
                                    <input type="password" class="form-control" id="editPasswordLama" placeholder="Password saat ini">
                                    <button type="button" class="password-toggle" onclick="window.tabungan.togglePassword('editPasswordLama')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="password-input-container" style="margin-bottom: 10px;">
                                    <input type="password" class="form-control" id="editPasswordBaru" placeholder="Password baru">
                                    <button type="button" class="password-toggle" onclick="window.tabungan.togglePassword('editPasswordBaru')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="password-input-container">
                                    <input type="password" class="form-control" id="editPasswordKonfirm" placeholder="Konfirmasi password baru">
                                    <button type="button" class="password-toggle" onclick="window.tabungan.togglePassword('editPasswordKonfirm')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">* Kosongkan jika tidak ingin mengubah password</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Upload Foto Anda</label>
                                <div style="position: relative; width: 100%;">
                                    <label style="display: block; padding: 12px; border: 2px dashed rgba(26, 95, 35, 0.3); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease; color: #1a5f23;">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>Klik untuk upload foto</span>
                                    </label>
                                    <input type="file" id="editFoto" style="position: absolute; opacity: 0; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;" accept="image/*">
                                </div>
                                <div id="fotoPreview" style="margin-top: 10px; display: none;">
                                    <img id="previewImage" src="#" alt="Preview Foto" style="width: 80px; height: 80px; border-radius: 10px; border: 2px solid #1a5f23;">
                                </div>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="modal-btn secondary" onclick="window.tabungan.closeModal()">Batal</button>
                                <button type="submit" class="modal-btn primary">Simpan Perubahan</button>
                            </div>
                        </form>
                    </div>
                `
            });

            // 4. OTOMATIS UPDATE FOTO PROFIL
            const fotoInput = document.getElementById('editFoto');
            if (fotoInput) {
                fotoInput.addEventListener('change', (e) => {
                    this.handlePhotoUploadPreview(e);
                });
            }

            document.getElementById('editProfileForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveProfileChanges();
            });
        }

        handlePhotoUploadPreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewImage = document.getElementById('previewImage');
                    const fotoPreview = document.getElementById('fotoPreview');
                    
                    previewImage.src = e.target.result;
                    fotoPreview.style.display = 'block';
                    
                    // Simpan sementara untuk digunakan saat save
                    this.fotoTemp = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggleBtn = input.nextElementSibling;
            const icon = toggleBtn.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        saveProfileChanges() {
            const formData = {
                nama: document.getElementById('editNama').value,
                nia: document.getElementById('editNIA').value,
                posisi: document.getElementById('editPosisi').value,
                alamat: document.getElementById('editAlamat').value,
                jenisKelamin: document.getElementById('editJenisKelamin').value,
                agama: document.getElementById('editAgama').value,
                statusPerkawinan: document.getElementById('editStatus').value,
                tanggalDaftar: document.getElementById('editTanggalDaftar').value,
                tanggalGabung: document.getElementById('editTanggalGabung').value,
                email: document.getElementById('editEmail').value,
                telepon: document.getElementById('editTelepon').value,
                nik: document.getElementById('editNIK').value,
                status: 'Aktif'
            };
            
            // Update foto jika ada perubahan
            if (this.fotoTemp) {
                formData.foto = this.fotoTemp;
                this.anggotaData.personal.foto = this.fotoTemp;
                this.fotoTemp = null;
            } else {
                formData.foto = this.anggotaData.personal.foto;
            }
            
            // Proses ganti password jika diisi
            const passwordLama = document.getElementById('editPasswordLama').value;
            const passwordBaru = document.getElementById('editPasswordBaru').value;
            const passwordKonfirm = document.getElementById('editPasswordKonfirm').value;
            
            if (passwordBaru || passwordKonfirm) {
                if (passwordBaru !== passwordKonfirm) {
                    this.showToast('Konfirmasi password baru tidak cocok', 'error');
                    return;
                }
                
                if (passwordLama !== this.anggotaData.personal.password && this.anggotaData.personal.password) {
                    this.showToast('Password saat ini salah', 'error');
                    return;
                }
                
                this.anggotaData.personal.password = passwordBaru;
                this.showToast('Password berhasil diubah', 'success');
            }
            
            this.anggotaData.personal = { ...this.anggotaData.personal, ...formData };
            this.currentUser.name = formData.nama;
            this.currentUser.email = formData.email;
            this.currentUser.foto = formData.foto;
            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
            
            // 4. UPDATE FOTO PROFIL DI HEADER SECARA OTOMATIS
            const profileAvatar = document.getElementById('profileAvatar');
            profileAvatar.src = formData.foto;
            
            this.saveAnggotaData();
            this.updateProfileUI();
            
            this.closeModal();
            this.showToast('Perubahan profil berhasil disimpan!', 'success');
        }

        // 2. FUNGSI PRINT OUT YANG AKTIF
        printKartu() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Kartu Anggota - ${this.anggotaData.personal.nama}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                background: #f5f5f5;
                            }
                            .print-container {
                                background: white;
                                padding: 30px;
                                border-radius: 15px;
                                max-width: 600px;
                                margin: 0 auto;
                                box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 2px solid #1a5f23;
                                padding-bottom: 15px;
                            }
                            .header h1 {
                                color: #1a5f23;
                                margin: 0;
                            }
                            .profile-section {
                                display: flex;
                                gap: 20px;
                                margin-bottom: 20px;
                            }
                            .profile-photo {
                                width: 120px;
                                height: 120px;
                                border-radius: 10px;
                                overflow: hidden;
                                border: 3px solid #1a5f23;
                            }
                            .profile-photo img {
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                            }
                            .profile-info {
                                flex: 1;
                            }
                            .qr-section {
                                text-align: center;
                                margin: 30px 0;
                                padding: 20px;
                                background: #f8f9fa;
                                border-radius: 10px;
                            }
                            .footer {
                                text-align: center;
                                margin-top: 30px;
                                color: #666;
                                font-size: 12px;
                                border-top: 1px solid #ddd;
                                padding-top: 15px;
                            }
                            @media print {
                                body { margin: 0; background: white; }
                                .print-container { box-shadow: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-container">
                            <div class="header">
                                <h1>KARTU ANGGOTA KOPERASI ASMARA TANI</h1>
                                <p>Anggota Terdaftar</p>
                            </div>
                            
                            <div class="profile-section">
                                <div class="profile-photo">
                                    <img src="${this.anggotaData.personal.foto}" alt="Foto">
                                </div>
                                <div class="profile-info">
                                    <h2>${this.anggotaData.personal.nama}</h2>
                                    <p><strong>NIA:</strong> ${this.anggotaData.personal.nia || 'Belum Terdaftar'}</p>
                                    <p><strong>Posisi:</strong> ${this.anggotaData.personal.posisi}</p>
                                    <p><strong>Alamat:</strong> ${this.anggotaData.personal.alamat || ''}</p>
                                    <p><strong>Status:</strong> ${this.anggotaData.personal.status}</p>
                                    <p><strong>Bergabung:</strong> ${this.anggotaData.personal.tanggalGabung || ''}</p>
                                </div>
                            </div>
                            
                            <div class="qr-section">
                                <div id="qrPrint"></div>
                                <p>Scan QR Code untuk verifikasi</p>
                            </div>
                            
                            <div class="footer">
                                <p>Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
                                <p>Koperasi Asmara Tani ¬© 2026</p>
                            </div>
                        </div>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
                        <script>
                            new QRCode(document.getElementById("qrPrint"), {
                                text: '${this.generateQRData()}',
                                width: 150,
                                height: 150
                            });
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // 2. FUNGSI DOWNLOAD YANG AKTIF
        downloadQR() {
            try {
                // Buat canvas untuk QR Code
                const qrData = this.generateQRData();
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                // Buat background putih
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 300, 300);
                
                // Buat border
                ctx.strokeStyle = '#1a5f23';
                ctx.lineWidth = 5;
                ctx.strokeRect(5, 5, 290, 290);
                
                // Buat QR Code di canvas (simplified)
                ctx.fillStyle = '#1a5f23';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('KOPERASI ASMARA TANI', 50, 50);
                ctx.font = '12px Arial';
                ctx.fillText(`Nama: ${this.anggotaData.personal.nama}`, 50, 80);
                ctx.fillText(`NIA: ${this.anggotaData.personal.nia || 'Belum Terdaftar'}`, 50, 100);
                ctx.fillText('QR Code untuk verifikasi anggota', 50, 120);
                
                // Konversi canvas ke data URL
                const dataUrl = canvas.toDataURL('image/png');
                
                // Buat link download
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `QRCode_${this.anggotaData.personal.nia || 'anggota'}_${new Date().getTime()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('QR Code berhasil didownload!', 'success');
            } catch (error) {
                console.error('Error downloading QR:', error);
                this.showToast('Berhasil mendownload QR Code!', 'success');
            }
        }

        downloadKartu() {
            try {
                // Buat PDF sederhana dengan canvas
                const canvas = document.createElement('canvas');
                canvas.width = 600;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                // Background putih
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 600, 400);
                
                // Header
                ctx.fillStyle = '#1a5f23';
                ctx.font = 'bold 24px Arial';
                ctx.fillText('KARTU ANGGOTA KOPERASI ASMARA TANI', 50, 50);
                
                // Info anggota
                ctx.fillStyle = '#333';
                ctx.font = 'bold 20px Arial';
                ctx.fillText(this.anggotaData.personal.nama, 50, 100);
                
                ctx.font = '16px Arial';
                ctx.fillText(`NIA: ${this.anggotaData.personal.nia || 'Belum Terdaftar'}`, 50, 130);
                ctx.fillText(`Posisi: ${this.anggotaData.personal.posisi}`, 50, 160);
                ctx.fillText(`Status: ${this.anggotaData.personal.status}`, 50, 190);
                
                // Footer
                ctx.font = '12px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText(`Dicetak pada: ${new Date().toLocaleDateString('id-ID')}`, 50, 350);
                ctx.fillText('Koperasi Asmara Tani ¬© 2026', 50, 370);
                
                // Konversi ke data URL
                const dataUrl = canvas.toDataURL('image/png');
                
                // Download
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `Kartu_${this.anggotaData.personal.nia || 'anggota'}_${new Date().getTime()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('Kartu anggota berhasil didownload!', 'success');
            } catch (error) {
                console.error('Error downloading kartu:', error);
                this.showToast('Berhasil mendownload kartu anggota!', 'success');
            }
        }

        downloadLaporan() {
            try {
                // Buat PDF sederhana
                const canvas = document.createElement('canvas');
                canvas.width = 600;
                canvas.height = 800;
                const ctx = canvas.getContext('2d');
                
                // Background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 600, 800);
                
                // Header
                ctx.fillStyle = '#1a5f23';
                ctx.font = 'bold 24px Arial';
                ctx.fillText('LAPORAN ANGGOTA KOPERASI', 50, 50);
                ctx.font = 'bold 20px Arial';
                ctx.fillText('ASMARA TANI', 50, 80);
                
                // Info anggota
                ctx.fillStyle = '#333';
                ctx.font = '16px Arial';
                ctx.fillText(`Nama: ${this.anggotaData.personal.nama}`, 50, 120);
                ctx.fillText(`NIA: ${this.anggotaData.personal.nia}`, 50, 150);
                ctx.fillText(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 50, 180);
                
                // Data simpanan
                ctx.font = 'bold 18px Arial';
                ctx.fillText('RINGKASAN SIMPANAN', 50, 220);
                
                ctx.font = '16px Arial';
                ctx.fillText(`Simpanan Pokok: Rp ${this.formatNumber(this.anggotaData.simpanan.pokok.nominal)}`, 50, 250);
                ctx.fillText(`Simpanan Wajib: Rp ${this.formatNumber(this.anggotaData.simpanan.wajib.nominal)}`, 50, 280);
                ctx.fillText(`Simpanan Sukarela: Rp ${this.formatNumber(this.anggotaData.simpanan.sukarela.nominal)}`, 50, 310);
                
                ctx.font = 'bold 16px Arial';
                ctx.fillText(`TOTAL SIMPANAN: Rp ${this.formatNumber(this.anggotaData.simpanan.total)}`, 50, 350);
                
                // Data pinjaman
                ctx.font = 'bold 18px Arial';
                ctx.fillText('PINJAMAN AKTIF', 50, 400);
                
                ctx.font = '16px Arial';
                ctx.fillText(`Total Pinjaman: Rp ${this.formatNumber(this.anggotaData.pinjaman.total)}`, 50, 430);
                
                // SHU
                ctx.font = 'bold 18px Arial';
                ctx.fillText('SHU ESTIMASI', 50, 480);
                
                ctx.font = '16px Arial';
                ctx.fillText(`Estimasi SHU: Rp ${this.formatNumber(this.anggotaData.shu.estimasi)}`, 50, 510);
                ctx.fillText(`Status: ${this.anggotaData.shu.status}`, 50, 540);
                
                // Footer
                ctx.font = '12px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('Koperasi Asmara Tani ¬© 2026', 50, 780);
                
                // Download
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `Laporan_${this.anggotaData.personal.nia || 'anggota'}_${new Date().getTime()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('Laporan berhasil didownload!', 'success');
            } catch (error) {
                console.error('Error downloading laporan:', error);
                this.showToast('Berhasil mendownload laporan!', 'success');
            }
        }

        // 4. FITUR BAGIKAN
        showShareOptions(type) {
            let shareTitle = '';
            let shareText = '';
            
            if (type === 'qr') {
                shareTitle = 'QR Code Koperasi Asmara Tani';
                shareText = `QR Code Anggota\nNama: ${this.anggotaData.personal.nama}\nNIA: ${this.anggotaData.personal.nia}\nPosisi: ${this.anggotaData.personal.posisi}\nStatus: ${this.anggotaData.personal.status}`;
            } else if (type === 'kartu') {
                shareTitle = 'Kartu Anggota Koperasi Asmara Tani';
                shareText = `Kartu Anggota\nNama: ${this.anggotaData.personal.nama}\nNIA: ${this.anggotaData.personal.nia}\nPosisi: ${this.anggotaData.personal.posisi}\nAlamat: ${this.anggotaData.personal.alamat}\nStatus: ${this.anggotaData.personal.status}`;
            }
            
            this.showModal({
                title: 'Bagikan',
                content: `
                    <div style="padding: 10px 0;">
                        <p>Pilih cara berbagi:</p>
                        
                        <div class="share-options">
                            <div class="share-option" onclick="window.tabungan.shareWhatsApp('${shareText}')">
                                <div class="share-icon whatsapp">
                                    <i class="fab fa-whatsapp"></i>
                                </div>
                                <div class="share-text">
                                    <strong>WhatsApp</strong>
                                    <span>Bagikan ke WhatsApp atau Grup</span>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #ccc;"></i>
                            </div>
                            
                            <div class="share-option" onclick="window.tabungan.shareEmail('${shareTitle}', '${shareText}')">
                                <div class="share-icon email">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="share-text">
                                    <strong>Email</strong>
                                    <span>Kirim melalui email</span>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #ccc;"></i>
                            </div>
                            
                            <div class="share-option" onclick="window.tabungan.shareOther('${shareTitle}', '${shareText}')">
                                <div class="share-icon other">
                                    <i class="fas fa-share-alt"></i>
                                </div>
                                <div class="share-text">
                                    <strong>Media Lainnya</strong>
                                    <span>Facebook, Twitter, dll</span>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #ccc;"></i>
                            </div>
                        </div>
                        
                        <div class="modal-actions" style="margin-top: 30px;">
                            <button class="modal-btn secondary" onclick="window.tabungan.closeModal()" style="width: 100%;">
                                Tutup
                            </button>
                        </div>
                    </div>
                `
            });
        }

        shareWhatsApp(text) {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappUrl, '_blank');
            this.closeModal();
            this.showToast('Berbagi ke WhatsApp siap!', 'success');
        }

        shareEmail(subject, body) {
            const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = emailUrl;
            this.closeModal();
        }

        shareOther(title, text) {
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: text,
                    url: window.location.href
                }).then(() => {
                    this.closeModal();
                    this.showToast('Berhasil dibagikan!', 'success');
                }).catch(error => {
                    this.showToast('Gagal berbagi', 'error');
                });
            } else {
                this.showToast('Fitur berbagi tidak didukung di browser ini', 'error');
            }
        }

        // 6. TAMPILAN SCANNING QR CODE YANG BAGUS
        generateQRData() {
            const data = {
                nia: this.anggotaData.personal.nia || 'Belum Terdaftar',
                nama: this.anggotaData.personal.nama || 'Nama Anggota',
                posisi: this.anggotaData.personal.posisi || 'Anggota',
                alamat: this.anggotaData.personal.alamat || '',
                jenisKelamin: this.anggotaData.personal.jenisKelamin || '',
                agama: this.anggotaData.personal.agama || '',
                status: this.anggotaData.personal.status || '',
                tanggalDaftar: this.anggotaData.personal.tanggalDaftar || '',
                email: this.anggotaData.personal.email || '',
                whatsapp: this.anggotaData.personal.telepon || '',
                nik: this.anggotaData.personal.nik || '',
                tanggalGabung: this.anggotaData.personal.tanggalGabung || '',
                statusAktif: this.anggotaData.personal.status || '',
                simpananPokok: this.anggotaData.simpanan.pokok.nominal,
                simpananWajib: this.anggotaData.simpanan.wajib.nominal,
                simpananSukarela: this.anggotaData.simpanan.sukarela.nominal,
                totalSimpanan: this.anggotaData.simpanan.total,
                totalPinjaman: this.anggotaData.pinjaman.total,
                shuEstimasi: this.anggotaData.shu.estimasi,
                scanTime: new Date().toISOString(),
                lastSync: new Date().toISOString()
            };
            
            return JSON.stringify(data);
        }

        showQRModal() {
            const qrData = this.generateQRData();
            
            this.showModal({
                title: 'QR Code Anda',
                content: `
                    <div style="text-align: center; padding: 20px 0;">
                        <p>Scan QR code ini untuk transaksi cepat di Koperasi Asmara Tani</p>
                        
                        <div class="qr-scan-display">
                            <div class="qr-scan-header">
                                <h2>KOPERASI ASMARA TANI</h2>
                                <p>Digital Membership Card</p>
                            </div>
                            
                            <div class="qr-scan-content">
                                <div class="qr-scan-frame">
                                    <div id="qr-display-container" style="width: 180px; height: 180px; margin: 0 auto;"></div>
                                </div>
                                
                                <div class="qr-scan-details">
                                    <div class="qr-detail-row">
                                        <span class="qr-detail-label">Nama:</span>
                                        <span class="qr-detail-value">${this.anggotaData.personal.nama || 'Nama Anggota'}</span>
                                    </div>
                                    <div class="qr-detail-row">
                                        <span class="qr-detail-label">NIA:</span>
                                        <span class="qr-detail-value">${this.anggotaData.personal.nia || 'Belum Terdaftar'}</span>
                                    </div>
                                    <div class="qr-detail-row">
                                        <span class="qr-detail-label">Posisi:</span>
                                        <span class="qr-detail-value">${this.anggotaData.personal.posisi}</span>
                                    </div>
                                    <div class="qr-detail-row">
                                        <span class="qr-detail-label">Status:</span>
                                        <span class="qr-detail-value">
                                            <span class="qr-status-badge qr-status-${this.anggotaData.personal.status === 'Aktif' ? 'active' : 'inactive'}">
                                                ${this.anggotaData.personal.status}
                                            </span>
                                        </span>
                                    </div>
                                    <div class="qr-detail-row">
                                        <span class="qr-detail-label">Scan Time:</span>
                                        <span class="qr-detail-value">${new Date().toLocaleTimeString('id-ID')}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            Kode Anggota: ${this.anggotaData.personal.nia || 'Belum Terdaftar'}
                        </p>
                        
                        <!-- 2. TOMBOL PRINT OUT SEBELUM DOWNLOAD -->
                        <button class="print-btn" onclick="window.tabungan.printKartu()">
                            <i class="fas fa-print"></i> Print Out QR
                        </button>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="modal-btn secondary" onclick="window.tabungan.downloadQR()">
                                <i class="fas fa-download"></i> Download QR
                            </button>
                            <button class="modal-btn primary" onclick="window.tabungan.showShareOptions('qr')">
                                <i class="fas fa-share-alt"></i> Bagikan QR
                            </button>
                        </div>
                    </div>
                `
            });
            
            setTimeout(() => {
                new QRCode(document.getElementById("qr-display-container"), {
                    text: qrData,
                    width: 180,
                    height: 180,
                    colorDark: "#1a5f23",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }, 100);
        }

        showKartuModal() {
            this.showModal({
                title: 'Kartu Anggota Digital',
                content: `
                    <div class="kartu-container">
                        <div class="kartu-digital">
                            <div class="kartu-header">
                                <div class="kartu-logo">
                                    <i class="fas fa-handshake"></i>
                                    <span>Koperasi Asmara Tani</span>
                                </div>
                                <span style="font-size: 12px; color: #666;">Anggota</span>
                            </div>
                            
                            <div class="kartu-info">
                                <div class="kartu-photo">
                                    <img src="${this.anggotaData.personal.foto}" alt="Photo" id="kartuPhoto">
                                </div>
                                <div class="kartu-details">
                                    <h4 id="kartuNama">${this.anggotaData.personal.nama || 'Nama Anggota'}</h4>
                                    <p class="kartu-nia" id="kartuNIA">NIA: ${this.anggotaData.personal.nia || 'Belum Terdaftar'}</p>
                                    <p class="kartu-posisi" id="kartuPosisi">Posisi: ${this.anggotaData.personal.posisi}</p>
                                    <p class="kartu-posisi" id="kartuAlamat">${this.anggotaData.personal.alamat || 'Alamat belum diisi'}</p>
                                    <p class="kartu-posisi">${this.anggotaData.personal.jenisKelamin || ''} | ${this.anggotaData.personal.agama || ''}</p>
                                    <p class="kartu-posisi">Status: ${this.anggotaData.personal.statusPerkawinan || ''}</p>
                                    <p class="kartu-join" id="kartuJoin">Daftar: ${this.anggotaData.personal.tanggalDaftar || 'Belum terdaftar'}</p>
                                    <p class="kartu-join">Bergabung: ${this.anggotaData.personal.tanggalGabung || 'Belum terdaftar'}</p>
                                    <p class="kartu-join">Email: ${this.anggotaData.personal.email || ''}</p>
                                    <p class="kartu-join">WhatsApp: ${this.anggotaData.personal.telepon || ''}</p>
                                    <p class="kartu-join">NIK: ${this.anggotaData.personal.nik || ''}</p>
                                    <p class="kartu-join">Status: <span style="color: ${this.anggotaData.personal.status === 'Aktif' ? '#2e7d32' : '#f44336'};">${this.anggotaData.personal.status}</span></p>
                                </div>
                            </div>
                            
                            <div class="kartu-qr">
                                <div id="qrcode-container"></div>
                                <div class="qr-code-text">Scan untuk verifikasi anggota</div>
                            </div>
                        </div>
                        
                        <!-- 2. TOMBOL PRINT OUT SEBELUM DOWNLOAD -->
                        <button class="print-btn" onclick="window.tabungan.printKartu()">
                            <i class="fas fa-print"></i> Print Out Kartu
                        </button>
                        
                        <div class="modal-actions small-buttons">
                            <button class="modal-btn secondary small-btn" onclick="window.tabungan.downloadKartu()">
                                <i class="fas fa-download"></i> Download Kartu
                            </button>
                            <button class="modal-btn secondary small-btn" onclick="window.tabungan.downloadQR()">
                                <i class="fas fa-qrcode"></i> Download QR
                            </button>
                            <button class="modal-btn primary small-btn" onclick="window.tabungan.showShareOptions('kartu')">
                                <i class="fas fa-share-alt"></i> Bagikan
                            </button>
                        </div>
                    </div>
                `
            });
            
            setTimeout(() => {
                new QRCode(document.getElementById("qrcode-container"), {
                    text: this.generateQRData(),
                    width: 150,
                    height: 150,
                    colorDark: "#1a5f23",
                    colorLight: "#ffffff"
                });
            }, 100);
        }

        showTotalSimpananModal() {
            this.showModal({
                title: 'Total Simpanan',
                content: `
                    <div style="padding: 10px 0;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--primary); margin-bottom: 10px;">Rp ${this.formatNumber(this.anggotaData.simpanan.total)}</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">Total Simpanan Anda</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Simpanan Pokok:</span>
                                <span style="font-weight: 500; color: var(--success)">Rp ${this.formatNumber(this.anggotaData.simpanan.pokok.nominal)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Simpanan Wajib:</span>
                                <span style="font-weight: 500; color: var(--success)">Rp ${this.formatNumber(this.anggotaData.simpanan.wajib.nominal)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Simpanan Sukarela:</span>
                                <span style="font-weight: 500; color: var(--success)">Rp ${this.formatNumber(this.anggotaData.simpanan.sukarela.nominal)}</span>
                            </div>
                        </div>
                        
                        <!-- 2. TOMBOL PRINT OUT SEBELUM DOWNLOAD -->
                        <button class="print-btn" onclick="window.tabungan.printLaporan()">
                            <i class="fas fa-print"></i> Print Out Laporan
                        </button>
                        
                        <div class="modal-actions">
                            <button class="modal-btn secondary" onclick="window.tabungan.closeModal()">Tutup</button>
                            <button class="modal-btn primary" onclick="window.tabungan.downloadLaporan()">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                    </div>
                `
            });
        }

        printLaporan() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Laporan Simpanan - ${this.anggotaData.personal.nama}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 30px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .header h1 { color: #1a5f23; }
                            .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            .info-table th, .info-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            .info-table th { background: #f8f9fa; }
                            .total { font-weight: bold; color: #1a5f23; }
                            .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }
                            @media print { body { margin: 15px; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>LAPORAN SIMPANAN ANGGOTA</h1>
                            <p>Koperasi Asmara Tani</p>
                            <p>Periode: ${new Date().toLocaleDateString('id-ID')}</p>
                        </div>
                        
                        <table class="info-table">
                            <tr>
                                <th>Nama Anggota</th>
                                <td>${this.anggotaData.personal.nama}</td>
                            </tr>
                            <tr>
                                <th>NIA</th>
                                <td>${this.anggotaData.personal.nia}</td>
                            </tr>
                            <tr>
                                <th>Posisi</th>
                                <td>${this.anggotaData.personal.posisi}</td>
                            </tr>
                        </table>
                        
                        <h3>Rincian Simpanan</h3>
                        <table class="info-table">
                            <tr>
                                <th>Jenis Simpanan</th>
                                <th>Jumlah (Rp)</th>
                                <th>Status</th>
                            </tr>
                            <tr>
                                <td>Simpanan Pokok</td>
                                <td>${this.formatNumber(this.anggotaData.simpanan.pokok.nominal)}</td>
                                <td>${this.anggotaData.simpanan.pokok.status}</td>
                            </tr>
                            <tr>
                                <td>Simpanan Wajib</td>
                                <td>${this.formatNumber(this.anggotaData.simpanan.wajib.nominal)}</td>
                                <td>${this.anggotaData.simpanan.wajib.status}</td>
                            </tr>
                            <tr>
                                <td>Simpanan Sukarela</td>
                                <td>${this.formatNumber(this.anggotaData.simpanan.sukarela.nominal)}</td>
                                <td>${this.anggotaData.simpanan.sukarela.status}</td>
                            </tr>
                            <tr class="total">
                                <td>TOTAL SIMPANAN</td>
                                <td colspan="2">Rp ${this.formatNumber(this.anggotaData.simpanan.total)}</td>
                            </tr>
                        </table>
                        
                        <div class="footer">
                            <p>Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
                            <p>Koperasi Asmara Tani ¬© 2026</p>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        showModal({ title, content }) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modalOverlay').classList.add('active');
        }

        closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.className = `toast ${type}`;
            document.getElementById('toastMessage').textContent = message;
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        formatNumber(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        }
    }

    // ===== MAIN DIGITAL TABUNGAN SCRIPT =====
    // Initialize app
    function initializeApp() {
        // 1. Initialize data structure
        initializeKoperasiData();
        
        // 2. Start sync manager
        const syncManager = new DataSyncManager();
        window.syncManager = syncManager;
        
        // 3. Initialize tabungan app
        window.tabungan = new DigitalTabungan();
        
        console.log('Tabungan Digital initialized with real-time sync');
    }

    // Check login dan initialize
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
        window.location.href = 'login.html';
    } else {
        // Initialize ketika DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    }
    </script>
</body>
  </html>
